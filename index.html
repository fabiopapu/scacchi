<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Scacchi Fantasy</title>
<style>
  body { font-family:sans-serif; text-align:center; background:#f0f0f0; }
  #board { display:grid; grid-template:repeat(8,60px)/repeat(8,60px); margin:20px auto; }
  .cell { width:60px; height:60px; display:flex; align-items:center; justify-content:center; font-size:36px; cursor:pointer; }
  .light { background:#eee; }
  .dark { background:#666; color:#fff; }
  .piece { user-select:none; }
</style>
</head>
<body>
<h1>Scacchi Fantasy: Gandalf vs Sauron</h1>
<div id="info">Connessione...</div>
<div id="board"></div>

<script>
let board_state = [
  ["mor_rook","mor_knight","mor_specter","mor_queen","mor_king","mor_specter","mor_knight","mor_rook"],
  ["mor_pawn","mor_pawn","mor_pawn","mor_pawn","mor_pawn","mor_pawn","mor_pawn","mor_pawn"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["nim_pawn","nim_pawn","nim_pawn","nim_pawn","nim_pawn","nim_pawn","nim_pawn","nim_pawn"],
  ["nim_rook","nim_knight","nim_elf","nim_queen","nim_king","nim_elf","nim_knight","nim_rook"]
];

const pieces = {
  nim: { king:"ðŸ§™", queen:"ðŸ‘¸", rook:"ðŸ°", elf:"ðŸ§", knight:"â™˜", pawn:"â™™" },
  mor: { king:"ðŸ›¡ï¸", queen:"â™›", rook:"â™œ", specter:"ðŸ‘»", knight:"â™ž", pawn:"â™Ÿ" }
};

let selected = null;
let turn = 'nim';
let color = null;

const boardDiv = document.getElementById('board');
const info = document.getElementById('info');

const ws = new WebSocket(`wss://${location.host}`);

ws.onopen = () => console.log("Connesso al server WS");

ws.onmessage = event => {
  const data = JSON.parse(event.data);

  switch(data.type){
    case 'assignColor':
      color = data.color;
      info.textContent = `Sei ${color.toUpperCase()} | In attesa avversario...`;
      break;

    case 'bothConnected':
      info.textContent = `Giocatori connessi! Turno: ${turn.toUpperCase()}`;
      renderBoard();
      break;

    case 'move':
      board_state = data.board;
      turn = data.turn;
      renderBoard();
      break;

    case 'opponentLeft':
      info.textContent = "Avversario disconnesso!";
      break;

    case 'full':
      alert(data.msg);
      break;

    case 'wait':
      info.textContent = data.msg;
      break;
  }
};

function renderBoard(){
  boardDiv.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const cell = document.createElement('div');
      cell.className = 'cell '+((r+c)%2===0?'light':'dark');
      cell.dataset.row = r;
      cell.dataset.col = c;

      let code = board_state[r][c];
      if(code){
        const span = document.createElement('span');
        let [col,type] = code.split("_");
        span.textContent = pieces[col][type];
        span.className = 'piece';
        cell.appendChild(span);
      }

      cell.addEventListener('click', ()=>onCellClick(r,c));
      boardDiv.appendChild(cell);
    }
  }
  if(color) info.textContent = `Sei ${color.toUpperCase()} | Turno: ${turn.toUpperCase()}`;
}

function onCellClick(r,c){
  if(!color || color!==turn) return;
  if(selected){
    makeMove(selected.r,selected.c,r,c);
    selected=null;
  } else {
    if(board_state[r][c] && board_state[r][c].startsWith(color)) selected={r,c};
  }
}

function isMoveLegal(r1,c1,r2,c2){
  let code = board_state[r1][c1];
  if(!code) return false;
  let [col,type] = code.split("_");
  let target = board_state[r2][c2];
  if(target && target.startsWith(col)) return false;
  let dr = r2-r1, dc = c2-c1;
  if(type==='pawn'){
    let dir = col==='nim'?-1:1;
    if(dr===dir && dc===0 && !target) return true;
    if(dr===2*dir && dc===0 && !target && ((col==='nim'&&r1===6)||(col==='mor'&&r1===1)) && !board_state[r1+dir][c1]) return true;
    if(dr===dir && Math.abs(dc)===1 && target && !target.startsWith(col)) return true;
    return false;
  }
  return true;
}

function makeMove(r1,c1,r2,c2){
  if(!isMoveLegal(r1,c1,r2,c2)) return;
  let piece = board_state[r1][c1];
  if(piece.endsWith('pawn') && (r2===0 || r2===7)) piece = color+'_queen';
  board_state[r2][c2]=piece;
  board_state[r1][c1]='';
  turn = turn==='nim'?'mor':'nim';
  renderBoard();

  ws.send(JSON.stringify({type:'move', board:board_state, turn}));
}

renderBoard();
</script>
</body>
</html>
